#!/usr/bin/env node
'use strict';

var we = require('express');
var Nt = require('compression');
var Lt = require('morgan');
var express = require('@remix-run/express');
var Tt = require('path');
var Bt = require('open');
var Gt = require('latest-version');
var ee = require('ansi-colors');
var child_process = require('child_process');
var nanospinner = require('nanospinner');
var perf_hooks = require('perf_hooks');
var fs = require('fs');
var semver = require('semver');
require('color-convert');
var wt = require('os');
var util = require('util');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var we__default = /*#__PURE__*/_interopDefault(we);
var Nt__default = /*#__PURE__*/_interopDefault(Nt);
var Lt__default = /*#__PURE__*/_interopDefault(Lt);
var Tt__default = /*#__PURE__*/_interopDefault(Tt);
var Bt__default = /*#__PURE__*/_interopDefault(Bt);
var Gt__default = /*#__PURE__*/_interopDefault(Gt);
var ee__default = /*#__PURE__*/_interopDefault(ee);
var wt__default = /*#__PURE__*/_interopDefault(wt);

var ue=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(n,a)=>(typeof require<"u"?require:n)[a]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});var X={name:"git-truck",version:"1.8.4",private:!1,description:"Visualizing a Git repository",license:"MIT",main:"./cli.js",type:"module",sideEffects:!1,bin:"./cli.js",files:["LICENSE","README.md","build/","public/","cli.js"],scripts:{test:"npm run test:e2e && npm run test:unit","test:unit":"jest --coverage","test:e2e":"npx playwright test","pretest:e2e":"npm run build",build:"remix build && npm run build-cli","build-cli":"tsup --minify --treeshake --out-dir . ./app/cli.ts",dev:"remix dev",watch:"remix watch",start:"npm run build && node .",clean:"rimraf -rf build public/build .cache .temp",tsc:"tsc","pub-pre":"npm version prerelease && npm publish --tag next","pub-exp":"node ./scripts/publish-experimental.js",prepublishOnly:"npm run clean && npm run build",format:"eslint --cache --fix {src,scripts}/**/*.{ts,tsx,js,mjs} && prettier --log-level warn --write {src,scripts}/**/*.{ts,tsx,js,mjs}",lint:"eslint --cache --fix {src,scripts}/**/*.{ts,tsx,js,mjs}"},devDependencies:{"@mdi/js":"^7.3.67","@mdi/react":"^1.6.1","@playwright/test":"^1.39.0","@remix-run/dev":"2.3.1","@remix-run/eslint-config":"2.3.1","@remix-run/express":"^2.2.0","@remix-run/node":"2.3.1","@remix-run/react":"2.3.1","@remix-run/serve":"2.3.1","@styled-icons/material":"^10.47.0","@styled-icons/material-outlined":"^10.47.0","@styled-icons/octicons":"^10.47.0","@types/byte-size":"^8.1.1","@types/color-convert":"^2.0.2","@types/compression":"^1.7.5","@types/d3-hierarchy":"^3.1.5","@types/express":"^4.17.21","@types/jest":"^29.5.7","@types/morgan":"^1.9.9","@types/randomstring":"^1.1.11","@types/react":"^18.2.34","@types/react-dom":"^18.2.14","@types/semver":"^7.5.4","@types/yargs":"^17.0.29","@typescript-eslint/eslint-plugin":"^5.62.0","@typescript-eslint/parser":"^5.62.0","ansi-colors":"^4.1.3",autoprefixer:"^10.4.16","byte-size":"^8.1.1",clsx:"^2.0.0","color-convert":"^2.0.1",compression:"^1.7.4","cross-env":"^7.0.3","d3-hierarchy":"^3.1.2",dotenv:"^16.3.1",eslint:"^8.52.0","eslint-config-prettier":"^9.0.0","eslint-plugin-prettier":"^5.0.1","eslint-plugin-react":"^7.33.2",express:"^4.18.2","express-serve-static-core":"^0.1.1","get-port":"^6.1.2","github-colors":"github:ozh/github-colors","gitignore-parser":"^0.0.2",husky:"^8.0.3",ignore:"^5.2.4","is-binary-path":"^2.1.0",jest:"^29.7.0","lang-map":"^0.4.0","latest-version":"^7.0.0","lint-staged":"^15.0.2",morgan:"^1.10.0",nanospinner:"^1.1.0",open:"^8.4.2",postcss:"^8.4.31","prettier-plugin-tailwindcss":"^0.5.6",randomstring:"^1.3.0",react:"^18.2.0","react-dom":"^18.2.0","react-konami-code":"^2.3.0","react-use":"^17.4.0","react-use-size":"^3.0.2","remix-typedjson":"^0.3.1",rimraf:"^5.0.5",semver:"^7.5.4",tailwindcss:"^3.3.5","tiny-invariant":"^1.3.1","ts-jest":"^29.1.1",tsup:"^7.2.0",typescript:"^5.2.2",uniqolor:"^1.1.0",yargs:"^17.7.2"},jest:{preset:"ts-jest",testEnvironment:"node",setupFiles:["dotenv/config"],roots:["<rootDir>/src/"]},prettier:{semi:!1,printWidth:120,trailingComma:"none",plugins:["prettier-plugin-tailwindcss"]},"lint-staged":{"{src,scripts}/**/*.{ts,tsx,js,mjs}":["eslint --cache --fix","prettier --write"]},engines:{node:">=18.0.0"},repository:{type:"git",url:"git+https://github.com/git-truck/git-truck.git"},bugs:{url:"https://github.com/git-truck/git-truck/issues"},homepage:"https://github.com/git-truck/git-truck#readme",dependencies:{"@mdi/js":"^7.3.67","@mdi/react":"^1.6.1","@playwright/test":"^1.39.0","@remix-run/dev":"2.3.1","@remix-run/eslint-config":"2.3.1","@remix-run/express":"^2.2.0","@remix-run/node":"2.3.1","@remix-run/react":"2.3.1","@remix-run/serve":"2.3.1","@styled-icons/material":"^10.47.0","@styled-icons/material-outlined":"^10.47.0","@styled-icons/octicons":"^10.47.0","@types/byte-size":"^8.1.1","@types/color-convert":"^2.0.2","@types/compression":"^1.7.5","@types/d3-hierarchy":"^3.1.5","@types/express":"^4.17.21","@types/jest":"^29.5.7","@types/morgan":"^1.9.9","@types/randomstring":"^1.1.11","@types/react":"^18.2.34","@types/react-dom":"^18.2.14","@types/semver":"^7.5.4","@types/yargs":"^17.0.29","@typescript-eslint/eslint-plugin":"^5.62.0","@typescript-eslint/parser":"^5.62.0","ansi-colors":"^4.1.3",autoprefixer:"^10.4.16","byte-size":"^8.1.1",clsx:"^2.0.0","color-convert":"^2.0.1",compression:"^1.7.4","cross-env":"^7.0.3","d3-hierarchy":"^3.1.2",dotenv:"^16.3.1","duckdb-async":"^0.9.2",eslint:"^8.52.0","eslint-config-prettier":"^9.0.0","eslint-plugin-prettier":"^5.0.1","eslint-plugin-react":"^7.33.2",express:"^4.18.2","express-serve-static-core":"^0.1.1","get-port":"^6.1.2","github-colors":"github:ozh/github-colors","gitignore-parser":"^0.0.2",husky:"^8.0.3",ignore:"^5.2.4","is-binary-path":"^2.1.0",isbot:"latest",jest:"^29.7.0","lang-map":"^0.4.0","latest-version":"^7.0.0","lint-staged":"^15.0.2",morgan:"^1.10.0",nanospinner:"^1.1.0",open:"^8.4.2",postcss:"^8.4.31","prettier-plugin-tailwindcss":"^0.5.6",randomstring:"^1.3.0",react:"^18.2.0","react-dom":"^18.2.0","react-konami-code":"^2.3.0","react-use":"^17.4.0","react-use-size":"^3.0.2","remix-typedjson":"^0.3.1",rimraf:"^5.0.5",semver:"^7.5.4",tailwindcss:"^3.3.5","tiny-invariant":"^1.3.1","ts-jest":"^29.1.1",tsup:"^7.2.0",typescript:"^5.2.2",uniqolor:"^1.1.0",yargs:"^17.7.2"}};var ve=(p=>(p.SILENT="",p.ERROR="ERR",p.WARN="WRN",p.INFO="NFO",p.DEBUG="DBG",p))(ve||{}),Ne={SILENT:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},{ERROR:Ce,WARN:st,INFO:ot,DEBUG:it}=ve;function at(){return typeof process.env.LOG_LEVEL=="string"?(setTimeout(()=>{R.debug(`Setting log level to ${process.env.LOG_LEVEL} from environment variable`);}),Ne[process.env.LOG_LEVEL.toUpperCase()]):typeof process.env.LOG_LEVEL=="number"?(setTimeout(()=>{R.debug(`Setting log level to ${process.env.LOG_LEVEL} from environment variable`);}),process.env.LOG_LEVEL):null}var N=at(),fe=()=>N;function Le(s){let n=Ne[s.trim().toUpperCase()];if(typeof n>"u")throw new Error(`Invalid log level: ${s}`);N=n;}function ct(s){if(N!==null&&N>=1){let n=s instanceof Error?`${U(Ce)}${s.message}
${s.stack}`:`${U(Ce)}${s}`;console.error(n);}}function lt(s){if(N!==null&&N>=2){let n=`${U(st)}${s}`;console.warn(n);}}function ut(s){if(N!==null&&N>=3){let n=`${U(ot)}${s}`;console.info(n);}}function ft(s){if(N!==null&&N>=4){let n=`${U(it)}${s}`;console.debug(n);}}function pt(s){N!==null&&N>=3&&console.info(s);}function U(s){let n=(a,c=l=>l)=>`${c(` ${new Date().toLocaleTimeString()} ${a} `)} `;if(process.env.COLOR==="0")return `[${s}] `;switch(s){case"ERR":return n("ERR",ee__default.default.bgRedBright.black.bold);case"WRN":return n("WRN",ee__default.default.bgYellow.black.bold);case"NFO":return n("NFO",ee__default.default.bgBlueBright.black.bold);case"DBG":return n("DBG",ee__default.default.bgWhite.bold);default:throw Error("Invalid log level")}}var R={error:ct,warn:lt,info:ut,debug:ft,raw:pt};function v(s,n,a){return R.debug(`exec ${s} $ ${n} ${a.join(" ")}`),new Promise((c,l)=>{try{let p=child_process.spawn(n,a,{cwd:Tt.resolve(s)}),d=[],m=h=>l(h.toString().trim());p.once("error",m),p.stderr.once("data",m),p.stdout.on("data",h=>d.push(h)),p.stdout.on("end",()=>{c(Buffer.concat(d).toString().trim());});}catch(p){l(p);}})}function P(s){return Tt.resolve(s).split(Tt.sep).slice().reverse()[0]}var bt=s=>s<1e3?`${Math.round(s)}ms`:`${(s/1e3).toFixed(2)}s`;function Te(s){let n=[];for(let a=0;a<s;a++){let l=`${" ".repeat(s-a-1)}\u{1F69B}
`;n.push(l);}return n}function yt(){return fe()===null?nanospinner.createSpinner("",{interval:1e3/20,frames:Te(20)}):null}var _=null;async function D({job:s=async()=>null,beforeMsg:n="",afterMsg:a="",errorMsg:c="",ms:l=null}){_=yt();let p=(h,w=!1)=>{if(fe()!==0){if(_===null)return R.info(h);_.success({text:h}),w||_.start();}},d=h=>{_?(_.update({text:h,frames:Te(h.length)}),_.start()):R.info(h);},m=h=>_===null?R.error(h):_.error({text:h});n.length>0&&d(n);try{let h=perf_hooks.performance.now(),w=await s(),E=perf_hooks.performance.now(),O=ee__default.default.gray(`${bt(l||E-h)}`);return p(`${a} ${O}`,!0),[w,null]}catch(h){return m(c),R.error(h),[null,h]}}var Be=s=>Tt.resolve(s,"..");async function te(s){try{return [await s,null]}catch(n){return [null,n]}}var He=(s,n)=>[s,encodeURIComponent(n)].join("/"),Se=(s,n)=>{let a=["main","master"];return a.includes(s)?-1:a.includes(n)?1:s.toLowerCase().localeCompare(n.toLowerCase())},re=(s,n)=>{let a=semver.valid(semver.clean(s)),c=semver.valid(semver.clean(n));return !a||!c?a?1:c?-1:s.toLowerCase().localeCompare(n.toLowerCase()):semver.compare(a,c)};var k=class s{useCache=!0;repo;branch;catFileCache=new Map;blameCache=new Map;static instance=null;static initInstance(n){(!s.instance||s.instance.repo!==n)&&(s.instance=new s(n));}static destroyInstance(){s.instance=null;}static getInstance(){if(!s.instance)throw Error("ObjectDeflator not initialized");return s.instance}static async isGitRepo(n){let a=Tt.resolve(n,".git"),c=fs.existsSync(a);if(!c)return !1;let[,l]=await te(s.findBranchHead(n));return !!(c&&!l)}static async findBranchHead(n,a){if(!a){let[p,d]=await te(s._getRepositoryHead(n));if(d)throw d;a=p;}let c=Tt.join(n,".git");if(!fs.existsSync(c))throw Error("No git folder exists at "+c);let l=await s._revParse(c,a);return R.debug(`${a} -> [commit]${l}`),[l,a]}static getCachePath(n,a){return Tt.resolve(wt__default.default.tmpdir(),"git-truck",n,`${a}.json`)}async getRepositoryHead(){return await s._getRepositoryHead(this.repo)}async gitShow(n){if(!this.branch)throw Error("branch not set");let a=["show","--no-patch",'--format="author <|%an|> date <|%at|> message <|%s|> body <|%b|> hash <|%H|>"',...n];return (await v(this.repo,"git",a)).trim()}static async _getRepositoryHead(n){return (await v(n,"git",["rev-parse","--abbrev-ref","HEAD"])).trim()}async lsTree(n){return await s._lsTree(this.repo,n)}static async _lsTree(n,a){return (await v(n,"git",["ls-tree","-rlt",a])).trim()}async revParse(n){return await s._revParse(this.repo,n)}static async _revParse(n,a){return (await v(n,"git",["rev-list","-n","1",a])).trim()}static async getRepoMetadata(n,a){let c=P(n);if(!await s.isGitRepo(n))return null;let p=s.parseRefs(await s._getRefs(n)),d=new Set([...Object.entries(p.Branches),...Object.entries(p.Tags)]).values(),h=(await Promise.all(Array.from(d).map(async([E,O])=>{let[S]=await s.retrieveCachedResult({repo:P(n),branch:E,branchHead:O,invalidateCache:a});return {headName:E,head:O,isAnalyzed:S!==null}}))).filter(E=>E.isAnalyzed).reduce((E,O)=>({...E,[O.head]:!0,[O.headName]:!0}),{}),w={name:c,path:n,data:null,reasons:[],currentHead:await s._getRepositoryHead(n),refs:p,analyzedHeads:h};try{let[E,O]=await te(s.findBranchHead(n));if(!O){let[S,M]=E,[J,B]=await s.retrieveCachedResult({repo:c,branch:M,branchHead:S,invalidateCache:a});w.data=J,w.reasons=B;}}catch{return null}return w}static async scanDirectoryForRepositories(n,a){let c=null,[l]=await D({job:()=>s.isGitRepo(n),beforeMsg:"Checking if path is a git repo...",afterMsg:"Done checking if path is a git repo",errorMsg:"Error checking if path is a git repo"}),p=Tt.resolve(l?Be(n):n),m=(await fs.promises.readdir(p,{withFileTypes:!0})).filter(E=>E.isDirectory()).map(({name:E})=>E),[h]=await D({job:()=>Promise.allSettled(m.map(async E=>{let O=await s.getRepoMetadata(Tt.join(p,E),a);if(!O)throw Error("Not a git repo");return O})),beforeMsg:"Scanning for repositories...",afterMsg:"Done scanning for repositories",errorMsg:"Error scanning for repositories"}),w=h.filter(E=>E.status==="rejected"?!1:(l&&E.value.name===P(n)&&(c=E.value),!0)).map(E=>E.value);return [c,w]}static parseRefs(n){let a={Branches:{},Tags:{}},c=/^(?<hash>.*) refs\/(?<ref_type>.*?)\/(?<path>.*)$/gm,l=n.matchAll(c),p=l.next();for(;p.value;){let d=p.value.groups;p=l.next();let m=d.hash,h=d.ref_type,w=d.path;switch(h){case"heads":a.Branches[w]=m;break;case"remotes":break;case"tags":a.Tags[w]=m;break;}}return a.Branches=Object.fromEntries(Object.entries(a.Branches).sort(([d],[m])=>Se(d,m))),a.Tags=Object.fromEntries(Object.entries(a.Tags).sort(([d],[m])=>re(d,m)*-1)),a}async gitLog(n,a){if(!this.branch)throw Error("branch not set");let c=["log",`--skip=${n}`,`--max-count=${a}`,this.branch,"--numstat",'--format="author <|%an|> date <|%at|> message <|%s|> body <|%b|> hash <|%H|>"'];return (await v(this.repo,"git",c)).trim()}static async retrieveCachedResult({repo:n,branch:a,branchHead:c,invalidateCache:l=!1}){if(l)return [null,["No cache was found"]];let p=[],d=s.getCachePath(n,a);if(!fs.existsSync(d))return [null,["No cache was found"]];let m=JSON.parse(await fs.promises.readFile(d,"utf8")),h=c===m.commit.hash;h||p.push("Branch head changed");let w=m.interfaceVersion===15;h||p.push("Outdated cache");let E=n===m.repo;return Object.values({branchHeadMatches:h,dataVersionMatches:w,repoMatches:E}).every(Boolean)?[m,p]:[null,p]}constructor(n){this.repo=n;}setUseCache(n){this.useCache=n;}async getRefs(){return await s._getRefs(this.repo)}static async _getRefs(n){return await v(n,"git",["show-ref"])}async catFile(n){return await v(this.repo,"git",["cat-file","-p",n])}async findBranchHead(n){return await s.findBranchHead(this.repo,n)}async catFileCached(n){if(this.useCache){let c=this.catFileCache.get(n);if(c)return c}let a=await this.catFile(n);return this.catFileCache.set(n,a),a}async getCommitCount(){if(!this.branch)throw Error("Branch is undefined");return await v(this.repo,"git",["rev-list","--count",this.branch])}async blame(n){if(!this.branch)throw Error("Branch is undefined");try{return await v(this.repo,"git",["blame",this.branch,"--",n])}catch{return R.warn(`Could not blame on ${n}. It might have been deleted since last commit.`),""}}async blameCached(n){if(!this.useCache){let c=this.blameCache.get(n);if(c)return c}let a=await this.blame(n);return this.blameCache.set(n,a),a}async parseBlame(n){let a=n.slice(n.indexOf("/")+1),c=await this.blameCached(a),l=/\((?<author>.*?)\s+\d{4}-\d{2}-\d{2}/gm,p=c.match(l),d={};return p?.forEach(m=>{let h=m.slice(1).slice(0,m.length-11).trim();if(h!=="Not Committed Yet"){let w=d[h]??0;d[h]=w+1;}}),d}async getDefaultGitSettingValue(n){return await v(this.repo,"git",["config",n])}async resetGitSetting(n,a){a?(await v(this.repo,"git",["config",n,a]),R.debug(`Reset ${n} to ${a}`)):(await v(this.repo,"git",["config","--unset",n]),R.debug(`Unset ${n}`));}async setGitSetting(n,a){await v(this.repo,"git",["config",n,a]),R.debug(`Set ${n} to ${a}`);}};function F(s){if(s!==s.toLowerCase()&&s!==s.toUpperCase()||(s=s.toLowerCase()),s.indexOf("-")===-1&&s.indexOf("_")===-1)return s;{let a="",c=!1,l=s.match(/^-+/);for(let p=l?l[0].length:0;p<s.length;p++){let d=s.charAt(p);c&&(c=!1,d=d.toUpperCase()),p!==0&&(d==="-"||d==="_")?c=!0:d!=="-"&&d!=="_"&&(a+=d);}return a}}function ne(s,n){let a=s.toLowerCase();n=n||"-";let c="";for(let l=0;l<s.length;l++){let p=a.charAt(l),d=s.charAt(l);p!==d&&l>0?c+=`${n}${a.charAt(l)}`:c+=d;}return c}function se(s){return s==null?!1:typeof s=="number"||/^0x[0-9a-f]+$/i.test(s)?!0:/^0[^.]/.test(s)?!1:/^[-]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(s)}function Me(s){if(Array.isArray(s))return s.map(d=>typeof d!="string"?d+"":d);s=s.trim();let n=0,a=null,c=null,l=null,p=[];for(let d=0;d<s.length;d++){if(a=c,c=s.charAt(d),c===" "&&!l){a!==" "&&n++;continue}c===l?l=null:(c==="'"||c==='"')&&!l&&(l=c),p[n]||(p[n]=""),p[n]+=c;}return p}var L;(function(s){s.BOOLEAN="boolean",s.STRING="string",s.NUMBER="number",s.ARRAY="array";})(L||(L={}));var H,oe=class{constructor(n){H=n;}parse(n,a){let c=Object.assign({alias:void 0,array:void 0,boolean:void 0,config:void 0,configObjects:void 0,configuration:void 0,coerce:void 0,count:void 0,default:void 0,envPrefix:void 0,narg:void 0,normalize:void 0,string:void 0,number:void 0,__:void 0,key:void 0},a),l=Me(n),p=typeof n=="string",d=xt(Object.assign(Object.create(null),c.alias)),m=Object.assign({"boolean-negation":!0,"camel-case-expansion":!0,"combine-arrays":!1,"dot-notation":!0,"duplicate-arguments-array":!0,"flatten-duplicate-arrays":!0,"greedy-arrays":!0,"halt-at-non-option":!1,"nargs-eats-options":!1,"negation-prefix":"no-","parse-numbers":!0,"parse-positional-numbers":!0,"populate--":!1,"set-placeholder-key":!1,"short-option-groups":!0,"strip-aliased":!1,"strip-dashed":!1,"unknown-options-as-args":!1},c.configuration),h=Object.assign(Object.create(null),c.default),w=c.configObjects||[],E=c.envPrefix,O=m["populate--"],S=O?"--":"_",M=Object.create(null),J=Object.create(null),B=c.__||H.format,i={aliases:Object.create(null),arrays:Object.create(null),bools:Object.create(null),strings:Object.create(null),numbers:Object.create(null),counts:Object.create(null),normalize:Object.create(null),configs:Object.create(null),nargs:Object.create(null),coercions:Object.create(null),keys:[]},T=/^-([0-9]+(\.[0-9]+)?|\.[0-9]+)$/,ie=new RegExp("^--"+m["negation-prefix"]+"(.+)");[].concat(c.array||[]).filter(Boolean).forEach(function(e){let r=typeof e=="object"?e.key:e,u=Object.keys(e).map(function(o){return {boolean:"bools",string:"strings",number:"numbers"}[o]}).filter(Boolean).pop();u&&(i[u][r]=!0),i.arrays[r]=!0,i.keys.push(r);}),[].concat(c.boolean||[]).filter(Boolean).forEach(function(e){i.bools[e]=!0,i.keys.push(e);}),[].concat(c.string||[]).filter(Boolean).forEach(function(e){i.strings[e]=!0,i.keys.push(e);}),[].concat(c.number||[]).filter(Boolean).forEach(function(e){i.numbers[e]=!0,i.keys.push(e);}),[].concat(c.count||[]).filter(Boolean).forEach(function(e){i.counts[e]=!0,i.keys.push(e);}),[].concat(c.normalize||[]).filter(Boolean).forEach(function(e){i.normalize[e]=!0,i.keys.push(e);}),typeof c.narg=="object"&&Object.entries(c.narg).forEach(([e,r])=>{typeof r=="number"&&(i.nargs[e]=r,i.keys.push(e));}),typeof c.coerce=="object"&&Object.entries(c.coerce).forEach(([e,r])=>{typeof r=="function"&&(i.coercions[e]=r,i.keys.push(e));}),typeof c.config<"u"&&(Array.isArray(c.config)||typeof c.config=="string"?[].concat(c.config).filter(Boolean).forEach(function(e){i.configs[e]=!0;}):typeof c.config=="object"&&Object.entries(c.config).forEach(([e,r])=>{(typeof r=="boolean"||typeof r=="function")&&(i.configs[e]=r);})),Ke(c.key,d,c.default,i.arrays),Object.keys(h).forEach(function(e){(i.aliases[e]||[]).forEach(function(r){h[r]=h[e];});});let $=null;rt();let Y=[],A=Object.assign(Object.create(null),{_:[]}),xe={};for(let e=0;e<l.length;e++){let r=l[e],u=r.replace(/^-{3,}/,"---"),o,t,g,f,b,j;if(r!=="--"&&/^-/.test(r)&&Q(r))ae(r);else if(u.match(/^---+(=|$)/)){ae(r);continue}else if(r.match(/^--.+=/)||!m["short-option-groups"]&&r.match(/^-.+=/))f=r.match(/^--?([^=]+)=([\s\S]*)$/),f!==null&&Array.isArray(f)&&f.length>=3&&(y(f[1],i.arrays)?e=K(e,f[1],l,f[2]):y(f[1],i.nargs)!==!1?e=q(e,f[1],l,f[2]):x(f[1],f[2],!0));else if(r.match(ie)&&m["boolean-negation"])f=r.match(ie),f!==null&&Array.isArray(f)&&f.length>=2&&(t=f[1],x(t,y(t,i.arrays)?[!1]:!1));else if(r.match(/^--.+/)||!m["short-option-groups"]&&r.match(/^-[^-]+/))f=r.match(/^--?(.+)/),f!==null&&Array.isArray(f)&&f.length>=2&&(t=f[1],y(t,i.arrays)?e=K(e,t,l):y(t,i.nargs)!==!1?e=q(e,t,l):(b=l[e+1],b!==void 0&&(!b.match(/^-/)||b.match(T))&&!y(t,i.bools)&&!y(t,i.counts)||/^(true|false)$/.test(b)?(x(t,b),e++):x(t,I(t))));else if(r.match(/^-.\..+=/))f=r.match(/^-([^=]+)=([\s\S]*)$/),f!==null&&Array.isArray(f)&&f.length>=3&&x(f[1],f[2]);else if(r.match(/^-.\..+/)&&!r.match(T))b=l[e+1],f=r.match(/^-(.\..+)/),f!==null&&Array.isArray(f)&&f.length>=2&&(t=f[1],b!==void 0&&!b.match(/^-/)&&!y(t,i.bools)&&!y(t,i.counts)?(x(t,b),e++):x(t,I(t)));else if(r.match(/^-[^-]+/)&&!r.match(T)){g=r.slice(1,-1).split(""),o=!1;for(let C=0;C<g.length;C++){if(b=r.slice(C+2),g[C+1]&&g[C+1]==="="){j=r.slice(C+3),t=g[C],y(t,i.arrays)?e=K(e,t,l,j):y(t,i.nargs)!==!1?e=q(e,t,l,j):x(t,j),o=!0;break}if(b==="-"){x(g[C],b);continue}if(/[A-Za-z]/.test(g[C])&&/^-?\d+(\.\d*)?(e-?\d+)?$/.test(b)&&y(b,i.bools)===!1){x(g[C],b),o=!0;break}if(g[C+1]&&g[C+1].match(/\W/)){x(g[C],b),o=!0;break}else x(g[C],I(g[C]));}t=r.slice(-1)[0],!o&&t!=="-"&&(y(t,i.arrays)?e=K(e,t,l):y(t,i.nargs)!==!1?e=q(e,t,l):(b=l[e+1],b!==void 0&&(!/^(-|--)[^-]/.test(b)||b.match(T))&&!y(t,i.bools)&&!y(t,i.counts)||/^(true|false)$/.test(b)?(x(t,b),e++):x(t,I(t))));}else if(r.match(/^-[0-9]$/)&&r.match(T)&&y(r.slice(1),i.bools))t=r.slice(1),x(t,I(t));else if(r==="--"){Y=l.slice(e+1);break}else if(m["halt-at-non-option"]){Y=l.slice(e);break}else ae(r);}Ae(A,!0),Ae(A,!1),We(A),Je(),je(A,i.aliases,h,!0),Ye(A),m["set-placeholder-key"]&&qe(A),Object.keys(i.counts).forEach(function(e){z(A,e.split("."))||x(e,0);}),O&&Y.length&&(A[S]=[]),Y.forEach(function(e){A[S].push(e);}),m["camel-case-expansion"]&&m["strip-dashed"]&&Object.keys(A).filter(e=>e!=="--"&&e.includes("-")).forEach(e=>{delete A[e];}),m["strip-aliased"]&&[].concat(...Object.keys(d).map(e=>d[e])).forEach(e=>{m["camel-case-expansion"]&&e.includes("-")&&delete A[e.split(".").map(r=>F(r)).join(".")],delete A[e];});function ae(e){let r=Z("_",e);(typeof r=="string"||typeof r=="number")&&A._.push(r);}function q(e,r,u,o){let t,g=y(r,i.nargs);if(g=typeof g!="number"||isNaN(g)?1:g,g===0)return G(o)||($=Error(B("Argument unexpected for: %s",r))),x(r,I(r)),e;let f=G(o)?0:1;if(m["nargs-eats-options"])u.length-(e+1)+f<g&&($=Error(B("Not enough arguments following: %s",r))),f=g;else {for(t=e+1;t<u.length&&(!u[t].match(/^-[^0-9]/)||u[t].match(T)||Q(u[t]));t++)f++;f<g&&($=Error(B("Not enough arguments following: %s",r)));}let b=Math.min(f,g);for(!G(o)&&b>0&&(x(r,o),b--),t=e+1;t<b+e+1;t++)x(r,u[t]);return e+b}function K(e,r,u,o){let t=[],g=o||u[e+1],f=y(r,i.nargs);if(y(r,i.bools)&&!/^(true|false)$/.test(g))t.push(!0);else if(G(g)||G(o)&&/^-/.test(g)&&!T.test(g)&&!Q(g)){if(h[r]!==void 0){let b=h[r];t=Array.isArray(b)?b:[b];}}else {G(o)||t.push(ce(r,o,!0));for(let b=e+1;b<u.length&&!(!m["greedy-arrays"]&&t.length>0||f&&typeof f=="number"&&t.length>=f||(g=u[b],/^-/.test(g)&&!T.test(g)&&!Q(g)));b++)e=b,t.push(ce(r,g,p));}return typeof f=="number"&&(f&&t.length<f||isNaN(f)&&t.length===0)&&($=Error(B("Not enough arguments following: %s",r))),x(r,t),e}function x(e,r,u=p){if(/-/.test(e)&&m["camel-case-expansion"]){let g=e.split(".").map(function(f){return F(f)}).join(".");Oe(e,g);}let o=ce(e,r,u),t=e.split(".");V(A,t,o),i.aliases[e]&&i.aliases[e].forEach(function(g){let f=g.split(".");V(A,f,o);}),t.length>1&&m["dot-notation"]&&(i.aliases[t[0]]||[]).forEach(function(g){let f=g.split("."),b=[].concat(t);b.shift(),f=f.concat(b),(i.aliases[e]||[]).includes(f.join("."))||V(A,f,o);}),y(e,i.normalize)&&!y(e,i.arrays)&&[e].concat(i.aliases[e]||[]).forEach(function(f){Object.defineProperty(xe,f,{enumerable:!0,get(){return r},set(b){r=typeof b=="string"?H.normalize(b):b;}});});}function Oe(e,r){i.aliases[e]&&i.aliases[e].length||(i.aliases[e]=[r],M[r]=!0),i.aliases[r]&&i.aliases[r].length||Oe(r,e);}function ce(e,r,u){u&&(r=Ot(r)),(y(e,i.bools)||y(e,i.counts))&&typeof r=="string"&&(r=r==="true");let o=Array.isArray(r)?r.map(function(t){return Z(e,t)}):Z(e,r);return y(e,i.counts)&&(G(o)||typeof o=="boolean")&&(o=de()),y(e,i.normalize)&&y(e,i.arrays)&&(Array.isArray(r)?o=r.map(t=>H.normalize(t)):o=H.normalize(r)),o}function Z(e,r){return !m["parse-positional-numbers"]&&e==="_"||!y(e,i.strings)&&!y(e,i.bools)&&!Array.isArray(r)&&(se(r)&&m["parse-numbers"]&&Number.isSafeInteger(Math.floor(parseFloat(`${r}`)))||!G(r)&&y(e,i.numbers))&&(r=Number(r)),r}function We(e){let r=Object.create(null);je(r,i.aliases,h),Object.keys(i.configs).forEach(function(u){let o=e[u]||r[u];if(o)try{let t=null,g=H.resolve(H.cwd(),o),f=i.configs[u];if(typeof f=="function"){try{t=f(g);}catch(b){t=b;}if(t instanceof Error){$=t;return}}else t=H.require(g);le(t);}catch(t){t.name==="PermissionDenied"?$=t:e[u]&&($=Error(B("Invalid JSON config file: %s",o)));}});}function le(e,r){Object.keys(e).forEach(function(u){let o=e[u],t=r?r+"."+u:u;typeof o=="object"&&o!==null&&!Array.isArray(o)&&m["dot-notation"]?le(o,t):(!z(A,t.split("."))||y(t,i.arrays)&&m["combine-arrays"])&&x(t,o);});}function Je(){typeof w<"u"&&w.forEach(function(e){le(e);});}function Ae(e,r){if(typeof E>"u")return;let u=typeof E=="string"?E:"",o=H.env();Object.keys(o).forEach(function(t){if(u===""||t.lastIndexOf(u,0)===0){let g=t.split("__").map(function(f,b){return b===0&&(f=f.substring(u.length)),F(f)});(r&&i.configs[g.join(".")]||!r)&&!z(e,g)&&x(g.join("."),o[t]);}});}function Ye(e){let r,u=new Set;Object.keys(e).forEach(function(o){if(!u.has(o)&&(r=y(o,i.coercions),typeof r=="function"))try{let t=Z(o,r(e[o]));[].concat(i.aliases[o]||[],o).forEach(g=>{u.add(g),e[g]=t;});}catch(t){$=t;}});}function qe(e){return i.keys.forEach(r=>{~r.indexOf(".")||typeof e[r]>"u"&&(e[r]=void 0);}),e}function je(e,r,u,o=!1){Object.keys(u).forEach(function(t){z(e,t.split("."))||(V(e,t.split("."),u[t]),o&&(J[t]=!0),(r[t]||[]).forEach(function(g){z(e,g.split("."))||V(e,g.split("."),u[t]);}));});}function z(e,r){let u=e;m["dot-notation"]||(r=[r.join(".")]),r.slice(0,-1).forEach(function(t){u=u[t]||{};});let o=r[r.length-1];return typeof u!="object"?!1:o in u}function V(e,r,u){let o=e;m["dot-notation"]||(r=[r.join(".")]),r.slice(0,-1).forEach(function(j){j=Ie(j),typeof o=="object"&&o[j]===void 0&&(o[j]={}),typeof o[j]!="object"||Array.isArray(o[j])?(Array.isArray(o[j])?o[j].push({}):o[j]=[o[j],{}],o=o[j][o[j].length-1]):o=o[j];});let t=Ie(r[r.length-1]),g=y(r.join("."),i.arrays),f=Array.isArray(u),b=m["duplicate-arguments-array"];!b&&y(t,i.nargs)&&(b=!0,(!G(o[t])&&i.nargs[t]===1||Array.isArray(o[t])&&o[t].length===i.nargs[t])&&(o[t]=void 0)),u===de()?o[t]=de(o[t]):Array.isArray(o[t])?b&&g&&f?o[t]=m["flatten-duplicate-arrays"]?o[t].concat(u):(Array.isArray(o[t][0])?o[t]:[o[t]]).concat([u]):!b&&!!g==!!f?o[t]=u:o[t]=o[t].concat([u]):o[t]===void 0&&g?o[t]=f?u:[u]:b&&!(o[t]===void 0||y(t,i.counts)||y(t,i.bools))?o[t]=[o[t],u]:o[t]=u;}function Ke(...e){e.forEach(function(r){Object.keys(r||{}).forEach(function(u){i.aliases[u]||(i.aliases[u]=[].concat(d[u]||[]),i.aliases[u].concat(u).forEach(function(o){if(/-/.test(o)&&m["camel-case-expansion"]){let t=F(o);t!==u&&i.aliases[u].indexOf(t)===-1&&(i.aliases[u].push(t),M[t]=!0);}}),i.aliases[u].concat(u).forEach(function(o){if(o.length>1&&/[A-Z]/.test(o)&&m["camel-case-expansion"]){let t=ne(o,"-");t!==u&&i.aliases[u].indexOf(t)===-1&&(i.aliases[u].push(t),M[t]=!0);}}),i.aliases[u].forEach(function(o){i.aliases[o]=[u].concat(i.aliases[u].filter(function(t){return o!==t}));}));});});}function y(e,r){let u=[].concat(i.aliases[e]||[],e),o=Object.keys(r),t=u.find(g=>o.includes(g));return t?r[t]:!1}function Re(e){let r=Object.keys(i);return [].concat(r.map(o=>i[o])).some(function(o){return Array.isArray(o)?o.includes(e):o[e]})}function Ze(e,...r){return [].concat(...r).some(function(o){let t=e.match(o);return t&&Re(t[1])})}function Qe(e){if(e.match(T)||!e.match(/^-[^-]+/))return !1;let r=!0,u,o=e.slice(1).split("");for(let t=0;t<o.length;t++){if(u=e.slice(t+2),!Re(o[t])){r=!1;break}if(o[t+1]&&o[t+1]==="="||u==="-"||/[A-Za-z]/.test(o[t])&&/^-?\d+(\.\d*)?(e-?\d+)?$/.test(u)||o[t+1]&&o[t+1].match(/\W/))break}return r}function Q(e){return m["unknown-options-as-args"]&&Xe(e)}function Xe(e){return e=e.replace(/^-{3,}/,"--"),e.match(T)||Qe(e)?!1:!Ze(e,/^-+([^=]+?)=[\s\S]*$/,ie,/^-+([^=]+?)$/,/^-+([^=]+?)-$/,/^-+([^=]+?\d+)$/,/^-+([^=]+?)\W+.*$/)}function I(e){return !y(e,i.bools)&&!y(e,i.counts)&&`${e}`in h?h[e]:et(tt(e))}function et(e){return {[L.BOOLEAN]:!0,[L.STRING]:"",[L.NUMBER]:void 0,[L.ARRAY]:[]}[e]}function tt(e){let r=L.BOOLEAN;return y(e,i.strings)?r=L.STRING:y(e,i.numbers)?r=L.NUMBER:y(e,i.bools)?r=L.BOOLEAN:y(e,i.arrays)&&(r=L.ARRAY),r}function G(e){return e===void 0}function rt(){Object.keys(i.counts).find(e=>y(e,i.arrays)?($=Error(B("Invalid configuration: %s, opts.count excludes opts.array.",e)),!0):y(e,i.nargs)?($=Error(B("Invalid configuration: %s, opts.count excludes opts.narg.",e)),!0):!1);}return {aliases:Object.assign({},i.aliases),argv:Object.assign(xe,A),configuration:m,defaulted:Object.assign({},J),error:$,newAliases:Object.assign({},M)}}};function xt(s){let n=[],a=Object.create(null),c=!0;for(Object.keys(s).forEach(function(l){n.push([].concat(s[l],l));});c;){c=!1;for(let l=0;l<n.length;l++)for(let p=l+1;p<n.length;p++)if(n[l].filter(function(m){return n[p].indexOf(m)!==-1}).length){n[l]=n[l].concat(n[p]),n.splice(p,1),c=!0;break}}return n.forEach(function(l){l=l.filter(function(d,m,h){return h.indexOf(d)===m});let p=l.pop();p!==void 0&&typeof p=="string"&&(a[p]=l);}),a}function de(s){return s!==void 0?s+1:1}function Ie(s){return s==="__proto__"?"___proto___":s}function Ot(s){return typeof s=="string"&&(s[0]==="'"||s[0]==='"')&&s[s.length-1]===s[0]?s.substring(1,s.length-1):s}var he,be,ye,Pe=process&&process.env&&process.env.YARGS_MIN_NODE_VERSION?Number(process.env.YARGS_MIN_NODE_VERSION):12,ze=(be=(he=process==null?void 0:process.versions)===null||he===void 0?void 0:he.node)!==null&&be!==void 0?be:(ye=process==null?void 0:process.version)===null||ye===void 0?void 0:ye.slice(1);if(ze&&Number(ze.match(/^([^.]+)/)[1])<Pe)throw Error(`yargs parser supports a minimum Node.js version of ${Pe}. Read our version support policy: https://github.com/yargs/yargs-parser#supported-nodejs-versions`);var vt=process?process.env:{},Ve=new oe({cwd:process.cwd,env:()=>vt,format:util.format,normalize:Tt.normalize,resolve:Tt.resolve,require:s=>{if(typeof ue<"u")return ue(s);if(s.match(/\.json$/))return JSON.parse(fs.readFileSync(s,"utf8"));throw Error("only .json config files are supported in ESM")}}),W=function(n,a){return Ve.parse(n.slice(),a).argv};W.detailed=function(s,n){return Ve.parse(s.slice(),n)};W.camelCase=F;W.decamelize=ne;W.looksLikeNumber=se;var Ue=W;function Ee(s=process.argv.slice(2)){return Ue(s,{configuration:{"duplicate-arguments-array":!1}})}function ke(){let s=Ee();return {path:".",hiddenFiles:[],unionedAuthors:[],invalidateCache:!1,...s}}async function _t(){let s=Ee();s?.log&&Le(s.log);let n=ke(),a=X.version,c="";try{let h=await Gt__default.default(X.name);process.stdout.write("\x1B[2J\x1B[0;0H"),console.log(),c=h&&re(h,a)===1?` [!] Update available: ${h}

To update, run:

npx git-truck@latest

Or to install globally:

npm install -g git-truck@latest

`:" (latest)";}catch{}console.log(`Git Truck version ${a}${c}
`),(s.h||s.help)&&(console.log(),console.log(`See

${X.homepage}

for usage instructions.`),console.log(),process.exit(0));let l=await import('get-port'),p=l.default,d=await p({port:[...l.portNumbers(3e3,4e3)]}),m=async()=>{let h=`http://localhost:${d}`,[w,E]=await D({job:async()=>{if(await k.isGitRepo(n.path)){let O=P(n.path);if(O){let S=await k._getRepositoryHead(n.path);return `/${He(O,S)}`}else return ""}},beforeMsg:"Checking for git repo",afterMsg:"Done checking for git repo",errorMsg:"Failed to check for git repo"});if(E&&console.error(E),process.env.NODE_ENV!=="development"){let O=h+(w??"");s.headless?console.log(`Application available at ${h}`):(R.debug(`Opening ${O}`),await D({job:()=>Bt__default.default(O),beforeMsg:"Opening Git Truck in your browser",afterMsg:"Opened Git Truck in your browser",errorMsg:`Failed to open Git Truck in your browser. To continue, open this link manually:

${O}
`}));}};D({job:async()=>{let h=Ht("./build/index.js",process.env.NODE_ENV??"production","/build",Tt__default.default.join(__dirname,"public","build")),w=process.env.HOST?h.listen(d,process.env.HOST,m):h.listen(d,m);["SIGTERM","SIGINT"].forEach(E=>{process.once(E,()=>w?.close(console.error));});},beforeMsg:"Starting app",afterMsg:"App started",errorMsg:"Failed to start app"});}_t();function Ht(s,n="production",a="/build/",c="public/build/"){let l=we__default.default();l.disable("x-powered-by"),l.use(Nt__default.default()),l.use(a,we__default.default.static(c,{immutable:!0,maxAge:"1y"})),l.use(we__default.default.static("public",{maxAge:"1h"})),n==="development"&&l.use(Lt__default.default("dev"));let p;return l.all("*",async(d,m,h)=>{try{if(!p){let w=await import(s);p=express.createRequestHandler({build:w,mode:n});}return await p(d,m,h)}catch(w){h?.(w);}}),l}
/*! Bundled license information:

yargs-parser/build/lib/string-utils.js:
  (**
   * @license
   * Copyright (c) 2016, Contributors
   * SPDX-License-Identifier: ISC
   *)

yargs-parser/build/lib/tokenize-arg-string.js:
  (**
   * @license
   * Copyright (c) 2016, Contributors
   * SPDX-License-Identifier: ISC
   *)

yargs-parser/build/lib/yargs-parser-types.js:
  (**
   * @license
   * Copyright (c) 2016, Contributors
   * SPDX-License-Identifier: ISC
   *)

yargs-parser/build/lib/yargs-parser.js:
  (**
   * @license
   * Copyright (c) 2016, Contributors
   * SPDX-License-Identifier: ISC
   *)

yargs-parser/build/lib/index.js:
  (**
   * @fileoverview Main entrypoint for libraries using yargs-parser in Node.js
   * CJS and ESM environments.
   *
   * @license
   * Copyright (c) 2016, Contributors
   * SPDX-License-Identifier: ISC
   *)
*/
